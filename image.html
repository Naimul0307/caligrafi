<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Arabic Transliteration</title>
    <style>
 @font-face {
            font-family: 'Diwani';
            src: url('fonts/DiwaniLetterRegular.ttf') format('truetype');
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }

        input, button {
            font-size: 18px;
            padding: 15px;
            margin: 20px;
        }

        #output {
            margin-top: 20px;
            font-size: 32px;
            font-weight: bold;
        }

        /* Center the generated image in the middle of the page */
        .canvas-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        canvas {
            border: 1px solid #ccc;
            display: none;
        }
    </style>

</head>
<body>
    <div>
        <h1>Offline Arabic Transliteration</h1>
        <label for="nameInput">Enter your name in Arabic:</label>
        <input type="text" id="nameInput" placeholder="Enter your name">
        
        <div class="canvas-container">
            <canvas id="calligraphyCanvas"></canvas>
            <button id="generateBtn" onclick="generateImage()">Generate Calligraphy Image</button>
            <button id="printBtn" style="display:none;" onclick="printImage()">Print Image</button>
        </div>
    </div>

    <script type="text/javascript" src="//api.yamli.com/js/yamli_api.js"></script>
    <script type="text/javascript">
        if (typeof(Yamli) == "object") {
            Yamli.init({
                uiLanguage: "en",
                startMode: "onOrUserDefault",
            });
            Yamli.yamlify('nameInput', {
                settingsPlacement: 'topLeft'
            });
        }
    
        const selectedBackground = localStorage.getItem('selectedBackground');
            function generateImage() {
            const name = document.getElementById('nameInput').value;

            // Retrieve saved settings
            const font = localStorage.getItem('selectedFont') || 'Diwani';
            const fontWeight = localStorage.getItem('selectedFontWeight') || 'normal';
            const fontSize = localStorage.getItem('fontSize') || '50'; // Default to 50px
            const canvasWidth = localStorage.getItem('canvasWidth') || '800'; 
            const canvasHeight = localStorage.getItem('canvasHeight') || '500'; 

            const canvas = document.getElementById('calligraphyCanvas');
            const ctx = canvas.getContext('2d');

            if (!font || font === "Select Font") {
                alert("Please select a font.");
                return;
            }

            // Apply dynamic canvas size
            canvas.width = parseInt(canvasWidth);
            canvas.height = parseInt(canvasHeight);

            // Check if a background image is selected
            if (selectedBackground) {
                const bgImage = new Image();
                bgImage.src = selectedBackground;

                bgImage.onload = function () {
                    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

                    document.fonts.load(`${fontSize}px ${font}`).then(() => {
                        document.fonts.ready.then(() => {
                            ctx.font = `${fontWeight} ${fontSize}px ${font}`;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillStyle = "black";
                            ctx.fillText(name, canvas.width / 2, canvas.height / 2);

                            // Show canvas and print button
                            canvas.style.display = 'block';
                            document.getElementById('printBtn').style.display = 'block';
                            document.getElementById('generateBtn').style.display = 'none';

                            saveImage();
                        });
                    }).catch(() => {
                        alert("Failed to load font. Try again.");
                    });
                };

                bgImage.onerror = function () {
                    alert("Failed to load background image.");
                };
            } else {
                alert("No background image selected.");
            }
        }

        function saveImage() {
        const canvas = document.getElementById('calligraphyCanvas');
        const imageData = canvas.toDataURL('image/png'); // Convert to base64

        fetch('/save-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ image: imageData }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Image saved successfully!');
            } else {
                alert('Failed to save image.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
        function printImage() {
            const canvas = document.getElementById('calligraphyCanvas');
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Print</title></head><body>');
            printWindow.document.write('<img src="' + canvas.toDataURL('image/png') + '" width="800" height="500"/>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
